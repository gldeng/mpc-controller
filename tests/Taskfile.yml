version: '3'

tasks:
  init:
    cmds:
       - cmd: sed -i "s|MYHOME|$HOME|g" ./tests/testsuites/createGroup.yml
       - cmd: sed -i "s|MYHOME|$HOME|g" ./tests/testsuites/requestKeygen.yml
       - cmd: sed -i "s|MYHOME|$HOME|g" ./tests/testsuites/initiateStake.yml
       - cmd: bash ./tests/scripts/kill.sh
         ignore_error: true
       - bash ./tests/scripts/clone.sh
       - bash ./tests/scripts/build.sh
       - bash ./tests/scripts/test_wd.sh
       - bash ./tests/scripts/start_avalanche.sh
       - bash ./tests/scripts/start_mpc-server.sh
       - sleep 20
       - bash ./tests/scripts/deploy_contract.sh
       - bash ./tests/scripts/start_mpc-controller.sh
       - bash ./tests/scripts/fund_participants.sh
       - sleep 10

  createGroup:
    cmds:
      - task: init
      - venom run tests/testsuites/createGroup.yml
      - sleep 10

  requestKeygen:
    cmds:
      - task: createGroup
      - venom run tests/testsuites/requestKeygen.yml
      - sleep 10

  initiateStake:
    cmds:
      - task: requestKeygen
      - bash ./tests/scripts/fund_initiateStake.sh
      - sleep 10
      - venom run tests/testsuites/initiateStake.yml
      - sleep 30

  initiateStakeSelfLoop:
    cmds:
      - bash ./tests/scripts/fund_initiateStake.sh
      - sleep 10
      - venom run tests/testsuites/initiateStake.yml
      - sleep 30
      - task: initiateStakeSelfLoop

  initiateStakeLoop:
    cmds:
      - task: initiateStake
      - task: initiateStakeSelfLoop

  cleanup: # todo: add more cleanup operation, such as rm -rf /tmp/mpctest if needed
    cmds:
      - cmd: bash tests/scripts/kill.sh
        ignore_error: true
